<<<<<<< HEAD
names_to = "gauge",
values_to = "CO2_contribution"
) |>
arrange(gauge) |>
mutate(
year = row_number() + 1958, # quick and dirty way to get the year because everything starts at 1959
.before = 1,
.by = gauge
)
# CO2 contribution graphs for a5 -----------------------------------------------
combined_parameters <- read_csv("./Results/CMAES_results/testing_new_CO2_model_parameters.csv", show_col_types = FALSE)
CO2_contribution_streamflow <- function(a5, CO2) {
altered_CO2_contribution <- CO2 - a5
altered_CO2_contribution[altered_CO2_contribution < 0] <- 0
return(altered_CO2_contribution)
}
shift_CO2_params <- combined_parameters |>
filter(parameter == "a5") |>
select(gauge, parameter_value)
sample_CO2_data <- data |>
filter(gauge == "102101A") |>
pull(CO2)
# CO2 contribution graphs for a5 -----------------------------------------------
combined_parameters <- read_csv("./Results/CMAES_results/testing_new_CO2_model_parameters.csv", show_col_types = FALSE)
CO2_contribution_streamflow <- function(a5, CO2) {
altered_CO2_contribution <- CO2 - a5
altered_CO2_contribution[altered_CO2_contribution < 0] <- 0
return(altered_CO2_contribution)
}
shift_CO2_params <- combined_parameters |>
filter(parameter == "a5") |>
select(gauge, parameter_value)
sample_CO2_data <- data |>
filter(gauge == "102101A") |>
pull(CO2)
CO2_contribution_timeseries <- map(
.x = shift_CO2_params$parameter_value,
.f = CO2_contribution_streamflow,
CO2 = sample_CO2_data
)
names(CO2_contribution_timeseries) <- shift_CO2_params$gauge
tidy_CO2_contribution_timeseries <- as_tibble(CO2_contribution_timeseries) |>
pivot_longer(
cols = everything(),
names_to = "gauge",
values_to = "CO2_contribution"
) |>
arrange(gauge) |>
mutate(
year = row_number() + 1958, # quick and dirty way to get the year because everything starts at 1959
.before = 1,
.by = gauge
)
# get year where CO2 starts to do something
# remove all zeroes by gauge
# slice_head by gauge
first_year_CO2_does_something <- tidy_CO2_contribution_timeseries |>
filter(CO2_contribution > 0) |>
slice_min(
CO2_contribution,
by = gauge
)
tidy_CO2_contribution_timeseries |>
ggplot(aes(x = year, y = CO2_contribution)) +
geom_line() +
labs(
x = "Year",
y = "Contribution of CO2-280 to streamflow model"
) +
theme_bw() +
facet_wrap(~gauge, scales = "free_y")
tidy_CO2_contribution_timeseries |>
ggplot(aes(x = year, y = CO2_contribution)) +
geom_line() +
labs(
x = "Year",
y = "Contribution of CO2 - 280 to streamflow model",
title = "When CO2 starts contributing to the model"
) +
theme_bw() +
facet_wrap(~gauge, scales = "free_y")
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, sf)
cat("\014") # clear console
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, sf)
# Import functions -------------------------------------------------------------
source("./Functions/utility.R")
source("./Functions/boxcox_transforms.R")
# Import data ------------------------------------------------------------------
CMAES_results <- read_csv("./Results/CMAES_results/CMAES_parameter_results.csv", show_col_types = FALSE)
streamflow_results <- read_csv("Results/CMAES_results/CMAES_streamflow_results.csv",
show_col_types = FALSE,
col_select = !optimiser
)
gauge_information <- read_csv("./Data/Tidy/gauge_information_CAMELS.csv",
show_col_types = FALSE,
col_select = c(gauge, bc_lambda, state, lat, lon)
) # CAMELS is Australia wide.
aus_map <- read_sf(dsn = "./Data/Maps",
layer = "AUS_2016_AUST")
vic_map <- read_sf(dsn = "./Data/Maps",
layer = "vic_map_simple")
# Gauges that do weird things - remove for now ---------------------------------
## Gauges visually inspected using check_model_fit in graphs
removed_gauges <- c("G0050115", "G0060005", "A0030501", "226220", "226407", "226222", "308145", "225020A")
best_CO2_and_non_CO2_per_catchment <- CMAES_results |>
filter(! gauge %in% removed_gauges) |>
select(!c(parameter, parameter_value, optimiser, loglikelihood, exit_message, near_bounds)) |>
distinct() |>
unite(
col = streamflow_model_objective_function,
c(streamflow_model, objective_function),
sep = "_",
remove = FALSE,
na.rm = FALSE
) |>
mutate(
contains_CO2 = str_detect(streamflow_model_objective_function, "CO2"),
contains_CO2 = if_else(contains_CO2, "CO2", "no_CO2"),
.after = 2
) |>
slice_min(
AIC,
by = c(gauge, contains_CO2)
)
evidence_ratio_calc <- best_CO2_and_non_CO2_per_catchment |>
select(!c(streamflow_model_objective_function, streamflow_model, objective_function)) |>
pivot_wider(
names_from = contains_CO2,
values_from = AIC
) |>
mutate(
AIC_difference = CO2 - no_CO2 # CO2 is smaller than non-CO2 then negative and CO2 is better
) |>
mutate(
evidence_ratio = case_when(
AIC_difference < 0 ~ -exp(0.5 * abs(AIC_difference)), # when CO2 model is better
AIC_difference > 0 ~ exp(0.5 * abs(AIC_difference)) # when non-CO2 model is better
)
)
# Plot time --------------------------------------------------------------------
plot_ready_data <- evidence_ratio_calc |>
select(!c(CO2, no_CO2, AIC_difference)) |>
left_join(
gauge_information,
by = join_by(gauge)
)
View(evidence_ratio_calc)
100000
# CO2 contribution graphs for a5 -----------------------------------------------
combined_parameters <- read_csv("./Results/CMAES_results/testing_new_CO2_model_parameters.csv", show_col_types = FALSE)
# Testing/Implementing new model
cat("\014") # clear console
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, cmaesr, smoof, tictoc, furrr, parallel, truncnorm, sloop, tictoc)
## Import annual streamflow, precip, CO2 and gauge data ========================
start_stop_indexes <- readr::read_csv(
"./Data/Tidy/start_end_index.csv",
show_col_types = FALSE
)
data <- readr::read_csv(
"./Data/Tidy/with_NA_yearly_data_CAMELS.csv",
col_types = "icdddddddll", # ensuring each column is a the correct type
show_col_types = FALSE
)
gauge_information <- readr::read_csv(
"./Data/Tidy/gauge_information_CAMELS.csv",
show_col_types = FALSE,
col_select = c(gauge, bc_lambda, state, lat, lon)
)
## Utility functions ===========================================================
source("./Functions/utility.R")
source("./Functions/boxcox_transforms.R")
## Import streamflow functions =================================================
source("./Functions/streamflow_models.R")
source("./Functions/parameter_transformations.R")
source("./Functions/catchment_data_blueprint.R")
source("./Functions/cmaes_dream_summaries.R")
source("./Functions/objective_functions.R")
source("./Functions/numerical_optimiser_setup.R")
source("./Functions/generic_functions.R")
source("./Functions/my_cmaes.R")
source("./Functions/objective_function_setup.R")
source("./Functions/result_set.R")
# CO2 contribution graphs for a5 -----------------------------------------------
combined_parameters <- read_csv("./Results/CMAES_results/testing_new_CO2_model_parameters.csv", show_col_types = FALSE)
View(combined_parameters)
# Fitting streamflow models to catchments
cat("\014") # clear console
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, cmaesr, smoof, tictoc, furrr, parallel, truncnorm, sloop, tictoc)
## Import annual streamflow, precip, CO2 and gauge data ========================
start_stop_indexes <- readr::read_csv(
"./Data/Tidy/start_end_index.csv",
show_col_types = FALSE
)
data <- readr::read_csv(
"./Data/Tidy/with_NA_yearly_data_CAMELS.csv",
col_types = "icdddddddll", # ensuring each column is a the correct type
show_col_types = FALSE
)
gauge_information <- readr::read_csv(
"./Data/Tidy/gauge_information_CAMELS.csv",
show_col_types = FALSE
)
View(data)
x <- data |>
pull(standardised_warm_season_to_annual_rainfall_ratio) |>
range()
View(data)
cat("\014") # clear console
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, sf)
# Import functions -------------------------------------------------------------
source("./Functions/utility.R")
source("./Functions/boxcox_transforms.R")
# Import data ------------------------------------------------------------------
CMAES_results <- read_csv("./Results/CMAES_results/CMAES_parameter_results.csv", show_col_types = FALSE)
streamflow_results <- read_csv("Results/CMAES_results/CMAES_streamflow_results.csv",
show_col_types = FALSE,
col_select = !optimiser
)
x <- CMAES_results |>
filter(parameter == "a4")
View(x)
x <- CMAES_results |>
filter(parameter == "a4") |>
pull(parameter_value) |>
range()
x <- CMAES_results |>
filter(parameter == "scale_CO2") |>
pull(parameter_value) |>
range()
x <- CMAES_results |>
filter(parameter == "sd") |>
pull(parameter_value) |>
range()
source("~/PHD/Papers/RQ2/climate-change-statistical-streamflow-modelling/Functions/streamflow_models.R")
# Testing/Implementing new model
cat("\014") # clear console
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, cmaesr, smoof, tictoc, furrr, parallel, truncnorm, sloop, tictoc)
## Import annual streamflow, precip, CO2 and gauge data ========================
start_stop_indexes <- readr::read_csv(
"./Data/Tidy/start_end_index.csv",
show_col_types = FALSE
)
data <- readr::read_csv(
"./Data/Tidy/with_NA_yearly_data_CAMELS.csv",
col_types = "icdddddddll", # ensuring each column is a the correct type
show_col_types = FALSE
)
gauge_information <- readr::read_csv(
"./Data/Tidy/gauge_information_CAMELS.csv",
show_col_types = FALSE,
col_select = c(gauge, bc_lambda, state, lat, lon)
)
## Utility functions ===========================================================
source("./Functions/utility.R")
gauge_information <- readr::read_csv(
"./Data/Tidy/gauge_information_CAMELS.csv",
show_col_types = FALSE,
col_select = c(gauge, bc_lambda, state, lat, lon)
)
View(gauge_information)
View(data)
## Utility functions ===========================================================
source("./Functions/utility.R")
source("./Functions/boxcox_transforms.R")
## Import streamflow functions =================================================
source("./Functions/streamflow_models.R")
source("./Functions/parameter_transformations.R")
source("./Functions/catchment_data_blueprint.R")
source("./Functions/cmaes_dream_summaries.R")
source("./Functions/objective_functions.R")
source("./Functions/numerical_optimiser_setup.R")
source("./Functions/generic_functions.R")
source("./Functions/my_cmaes.R")
source("./Functions/objective_function_setup.R")
source("./Functions/result_set.R")
gauge <- "401012"
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_separate_shifted_CO2,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set()
cmaes_example |> plot()
get_non_drought_streamflow_models()
x <- get_non_drought_streamflow_models()
View(x)
debugSource("~/PHD/Papers/RQ2/climate-change-statistical-streamflow-modelling/testing_new_CO2_model.R")
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_drought_separate_shifted_CO2_auto,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
gauge <- "401012"
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_drought_separate_shifted_CO2_seasonal_ratio,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_drought_separate_shifted_CO2_seasonal_ratio_auto,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_separate_shifted_CO2,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_separate_shifted_CO2_auto,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_separate_shifted_CO2_seasonal_ratio,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
cmaes_example <- gauge |>
catchment_data_blueprint(
observed_data = data,
start_stop_indexes = start_stop_indexes
) |>
numerical_optimiser_setup_vary_inputs(
streamflow_model = streamflow_model_separate_shifted_CO2_seasonal_ratio_auto,
objective_function = constant_sd_objective_function,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE
) |>
my_cmaes(print_monitor = TRUE) |>
result_set() |>
plot()
# Fitting streamflow models to catchments
cat("\014") # clear console
# Import libraries--------------------------------------------------------------
pacman::p_load(tidyverse, cmaesr, smoof, tictoc, furrr, parallel, truncnorm, sloop, tictoc)
## Import annual streamflow, precip, CO2 and gauge data ========================
start_stop_indexes <- readr::read_csv(
"./Data/Tidy/start_end_index.csv",
show_col_types = FALSE
)
data <- readr::read_csv(
"./Data/Tidy/with_NA_yearly_data_CAMELS.csv",
col_types = "icdddddddll", # ensuring each column is a the correct type
show_col_types = FALSE
)
gauge_information <- readr::read_csv(
"./Data/Tidy/gauge_information_CAMELS.csv",
show_col_types = FALSE
)
## Utility functions ===========================================================
source("./Functions/utility.R")
## Import streamflow functions =================================================
source("./Functions/streamflow_models.R")
source("./Functions/parameter_transformations.R")
source("./Functions/catchment_data_blueprint.R")
source("./Functions/cmaes_dream_summaries.R")
source("./Functions/objective_functions.R")
source("./Functions/numerical_optimiser_setup.R")
source("./Functions/generic_functions.R")
source("./Functions/my_cmaes.R")
source("./Functions/my_dream.R")
source("./Functions/objective_function_setup.R")
source("./Functions/result_set.R")
# Number of times we want to repeat each catchment-optimiser-streamflow model combinations
REPEATS <- 1L # should be 10
# Split catchments for into X chunks (due to RAM limitations).
# Must be a multiple of REPEATS to avoid duplication across chunks. There is a check in code just in case
CHUNK_SIZE <- 4500 # items per batch
# Construct catchment_data objects ---------------------------------------------
### All ########################################################################
all_catchment_data <- purrr::map(
.x = unique(data$gauge),
.f = catchment_data_blueprint,
observed_data = data,
start_stop_indexes = start_stop_indexes
)
### Drought ####################################################################
drought_gauges <- gauge_information |>
dplyr::filter(drought == TRUE) |>
dplyr::pull(gauge)
drought_catchment_data <- map(
.x = drought_gauges,
.f = catchment_data_blueprint,
observed_data = data,
start_stop_indexes = start_stop_indexes
)
# Build objective_functions using the optimiser_set object ---------------------
all_streamflow_models <- get_non_drought_streamflow_models()
drought_streamflow_models <- get_drought_streamflow_models()
all_objective_functions <- get_all_objective_functions()
View(all_streamflow_models)
all_streamflow_models[[1]]
all_streamflow_models[[1]]()
# Build objective_functions using the optimiser_set object ---------------------
all_streamflow_models <- get_non_drought_streamflow_models()
drought_streamflow_models <- get_drought_streamflow_models()
all_objective_functions <- get_all_objective_functions()
## Produce a tibble of all combinations of catchment, optimiser, etc ===========
ready_for_iteration <- tidyr::expand_grid(
all_catchment_data,
all_streamflow_models,
all_objective_functions
) |>
dplyr::distinct() # make sure there are no double ups
### Drought ####################################################################
drought_ready_for_iteration <- tidyr::expand_grid(
drought_catchment_data,
drought_streamflow_models,
all_objective_functions
) |>
dplyr::distinct()
## Make numerical_optimiser_setup using ready_for_iteration tibble =============
all_numerical_optimisers_cmaes <- pmap(
.l = list(
ready_for_iteration |> dplyr::pull(all_streamflow_models),
ready_for_iteration |> dplyr::pull(all_objective_functions),
ready_for_iteration |> dplyr::pull(all_catchment_data)
),
.f = numerical_optimiser_setup,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE # cmaes = TRUE, dream = FALSE
)
repeat_all_numerical_optimisers_cmaes <- rep(all_numerical_optimisers_cmaes, each = REPEATS)
chunk_repeat_all_numerical_optimisers_cmaes <- split( # required for chunking in parallel
repeat_all_numerical_optimisers_cmaes,
ceiling(seq_along(repeat_all_numerical_optimisers_cmaes) / CHUNK_SIZE)
)
View(chunk_repeat_all_numerical_optimisers_cmaes)
### Drought ####################################################################
drought_numerical_optimisers_cmaes <- pmap(
.l = list(
drought_ready_for_iteration |> dplyr::pull(drought_streamflow_models),
drought_ready_for_iteration |> dplyr::pull(all_objective_functions),
drought_ready_for_iteration |> dplyr::pull(drought_catchment_data)
),
.f = numerical_optimiser_setup,
bounds_and_transform_method = make_default_bounds_and_transform_methods(),
minimise_likelihood = TRUE # cmaes = TRUE, dream = FALSE
)
repeat_drought_numerical_optimisers_cmaes <- rep(drought_numerical_optimisers_cmaes, each = REPEATS)
chunk_repeat_all_drought_numerical_optimisers_cmaes <- split( # required for chunking in parallel
repeat_drought_numerical_optimisers_cmaes,
ceiling(seq_along(repeat_drought_numerical_optimisers_cmaes) / CHUNK_SIZE)
)
=======
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed) #|>
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed, streamflow) #|>
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed, streamflow, .keep_all = TRUE) #|>
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed, streamflow, .keep_all = TRUE) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) #|>
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
observed_minus_CO2 = observed - modelled
)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_streamflow - non_shifted_streamflow
)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - non_shifted_CO2
)
View(difference_to_observed_streamflow)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
difference_to_observed_streamflow$no_shifted_CO2[1]
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
filter(modelled_or_observed != "observed") |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_shifted_and_non_shifted_CO2 <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
filter(modelled_or_observed != "observed") |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
plot_difference_residuals <- difference_shifted_and_non_shifted_CO2 |>
ggplot(aes(x = year, y = shifted_CO2_minus_non_shifted_CO2)) +
geom_line(na.rm = TRUE) +
theme_bw() +
labs(
x = "Year",
y = "Observed streamflow minus CO2 model streamflow (mm)",
colour = "Residual Type",
title = "Observed minus modelled streamflow residuals"
) +
facet_wrap(~gauge, scales = "free_y", nrow = 5)
plot_difference_observed_residuals
plot_difference_residuals
View(shifted_streamflow)
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_streamflow, .keep = TRUE)
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep = TRUE) # remove duplicate observed_streamflow
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep_all = TRUE) # remove duplicate observed_streamflow
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep_all = TRUE) |>  # remove duplicate observed_streamflow
arrange(year)
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep_all = TRUE) |>  # remove duplicate observed_streamflow
arrange(gauge)
View(all_streamflow)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) #|>
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) #|>
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) #|>
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct()
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(!c(is_CO2_shifted, streamflow_model, objective_function))
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(is_CO2_shifted, streamflow_model, objective_function)
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
!distinct(is_CO2_shifted, streamflow_model, objective_function)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(pick(is_CO2_shifted, streamflow_model, objective_function))
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(!pick(is_CO2_shifted, streamflow_model, objective_function))
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(pick(!is_CO2_shifted, !streamflow_model, !objective_function))
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
mutate(
streamflow = boxcox_inverse_transform(boxcox_streamflow, lambda = bc_lambda),
modelled_or_observed = case_when(
modelled_or_observed == "observed_boxcox_streamflow" ~ "observed",
(modelled_or_observed == "modelled_boxcox_streamflow") & (!is_CO2_shifted) ~ "no_shifted_CO2",
(modelled_or_observed == "modelled_boxcox_streamflow") & (is_CO2_shifted) ~ "shifted_CO2",
)
)
View(streamflow_results)
View(streamflow_results)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
filter(gauge == "113004A") |>
filter(modelled_or_observed == "observed")
View(x)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
filter(gauge == "113004A") |>
filter(modelled_or_observed == "observed") |>
arrange(year)
View(x)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
filter(gauge == "113004A") |>
filter(modelled_or_observed == "observed") |>
arrange(year) |>
distinct(year, .keep_all = TRUE)
View(x)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
#filter(gauge == "113004A") |>
group_by(gauge) |>
filter(modelled_or_observed == "observed") |>
arrange(year) |>
distinct(year, .keep_all = TRUE)
View(x)
removed_observed_streamflow_results <- streamflow_results |>
filter(modelled_or_observed != "observed")
View(removed_observed_streamflow_results)
cleaned_streamflow_results <- streamflow_results |>
filter(modelled_or_observed != "observed") |>
rbind(cleaned_observed_flow)
# How to remove the duplicate observed streamflow?
cleaned_observed_flow <- streamflow_results |>
group_by(gauge) |>
filter(modelled_or_observed == "observed") |>
arrange(year) |>
distinct(year, .keep_all = TRUE) |>
ungroup()
cleaned_streamflow_results <- streamflow_results |>
filter(modelled_or_observed != "observed") |>
rbind(cleaned_observed_flow)
## Plot 1
plot_streamflow_timeseries <- cleaned_streamflow_results |>
ggplot(aes(x = year, y = streamflow, colour = modelled_or_observed)) +
geom_line(na.rm = TRUE, alpha = 0.9) +
theme_bw() +
scale_colour_brewer(palette = "Dark2") +
labs(
x = "Year",
y = "Streamflow (mm)",
title = "Streamflow timeseries"
) +
facet_wrap(~gauge, scales = "free_y", nrow = 5) +
theme(legend.title = element_blank())
ggsave(
filename = paste0("shifted_CO2_streamflow_timeseries_comparison_", get_date(), ".pdf"),
plot = plot_streamflow_timeseries,
device = "pdf",
path = "./Graphs/examination_selected_sites",
width = 297,
height = 210,
units = "mm"
)
## Plot 2 the shifted - non-shifted timeseries
difference_shifted_and_non_shifted_CO2 <- cleaned_streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
View(difference_shifted_and_non_shifted_CO2)
plot_difference_residuals <- difference_shifted_and_non_shifted_CO2 |>
ggplot(aes(x = year, y = shifted_CO2_minus_non_shifted_CO2)) +
geom_line(na.rm = TRUE) +
theme_bw() +
labs(
x = "Year",
y = "Observed streamflow minus CO2 model streamflow (mm)",
colour = "Residual Type",
title = "Observed minus modelled streamflow residuals"
) +
facet_wrap(~gauge, scales = "free_y", nrow = 5)
ggsave(
filename = paste0("shifted_CO2_vs_non_shifted_residuals", get_date(), ".pdf"),
plot = plot_difference_residuals,
device = "pdf",
path = "./Graphs/examination_selected_sites",
width = 297,
height = 210,
units = "mm"
)
View(difference_to_observed_streamflow)
View(difference_shifted_and_non_shifted_CO2)
## Plot 2 the shifted - non-shifted timeseries
difference_shifted_and_non_shifted_CO2 <- cleaned_streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2,
observed_minus_shifted = observed - shifted_CO2
)
list_of_observed_minus_CO2_per_catchment <- difference_shifted_and_non_shifted_CO2 |>
select(year, gauge, observed_minus_shifted) |>
pivot_wider(
names_from = gauge,
values_from = observed_minus_shifted
) |>
select(!year) |>
unclass()
remove_na_vector <- function(vector) {
vector[!is.na(vector)]
}
no_NA_list_of_observed_minus_CO2_per_catchment <- map(
.x = list_of_observed_minus_CO2_per_catchment,
.f = remove_na_vector
)
acf_objects_per_gauge <- map(
.x = no_NA_list_of_observed_minus_CO2_per_catchment,
.f = acf,
plot = FALSE
)
get_lags_from_acf <- function(acf_object, name = NULL) {
acf_tibble <- with(acf_object, tibble(lag, acf))
acf_tibble |>
add_column(
gauge = {{ name }},
.before = 1
)
}
lags_from_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = get_lags_from_acf
) |>
list_rbind()
confidence_intervals_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = tibble_confidence_interval_acf
) |>
list_rbind() |>
rename(
gauge = name
)
confidence_interval_acf <- function(acf_object, alpha = 0.05) {
return(qnorm((1 + (1 - alpha)) / 2) / sqrt(acf_object$n.used))
}
tibble_confidence_interval_acf <- function(acf_object, name = NULL, alpha = 0.05) {
upper_bound <- confidence_interval_acf(acf_object, alpha)
lower_bound <- -upper_bound
result_tibble <- as_tibble(cbind(name, upper_bound, lower_bound))
result_tibble$upper_bound <- as.numeric(upper_bound)
result_tibble$lower_bound <- as.numeric(lower_bound)
return(result_tibble)
}
list_of_observed_minus_CO2_per_catchment <- difference_shifted_and_non_shifted_CO2 |>
select(year, gauge, observed_minus_shifted) |>
pivot_wider(
names_from = gauge,
values_from = observed_minus_shifted
) |>
select(!year) |>
unclass()
remove_na_vector <- function(vector) {
vector[!is.na(vector)]
}
no_NA_list_of_observed_minus_CO2_per_catchment <- map(
.x = list_of_observed_minus_CO2_per_catchment,
.f = remove_na_vector
)
acf_objects_per_gauge <- map(
.x = no_NA_list_of_observed_minus_CO2_per_catchment,
.f = acf,
plot = FALSE
)
get_lags_from_acf <- function(acf_object, name = NULL) {
acf_tibble <- with(acf_object, tibble(lag, acf))
acf_tibble |>
add_column(
gauge = {{ name }},
.before = 1
)
}
lags_from_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = get_lags_from_acf
) |>
list_rbind()
confidence_intervals_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = tibble_confidence_interval_acf
) |>
list_rbind() |>
rename(
gauge = name
)
complete_acf_per_gauge <- lags_from_acf |>
left_join(
confidence_intervals_acf,
by = join_by(gauge)
)
acf_ggplot <- complete_acf_per_gauge |>
ggplot(aes(x = lag, y = acf)) +
geom_hline(aes(yintercept = 0), linewidth = 1) +
geom_segment(mapping = aes(xend = lag, yend = 0), linewidth = 1) +
geom_hline(
aes(yintercept = lower_bound),
linetype = 2,
linewidth = 1,
colour = "blue"
) +
geom_hline(
aes(yintercept = upper_bound),
linetype = 2,
linewidth = 1,
colour = "blue"
) +
labs(
x = "Lag",
y = "ACF",
title = "ACF graphs"
) +
theme_bw() +
facet_wrap(~gauge)
acf_ggplot
source("~/Documents/R-code/climate-change-statistical-streamflow-modelling/testing_new_CO2_model.R")
acf_ggplot
>>>>>>> 57d6ef0cacc1bdee78f58ced5843931c9d536ef6
