select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed) #|>
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed, streamflow) #|>
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed, streamflow, .keep_all = TRUE) #|>
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
distinct(modelled_or_observed, streamflow, .keep_all = TRUE) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) #|>
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
observed_minus_CO2 = observed - modelled
)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_streamflow - non_shifted_streamflow
)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - non_shifted_CO2
)
View(difference_to_observed_streamflow)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
difference_to_observed_streamflow$no_shifted_CO2[1]
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_to_observed_streamflow <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
filter(modelled_or_observed != "observed") |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
View(difference_to_observed_streamflow)
## Plot 2 the shifted - non-shifted timeseries
# ingore error. I will fix it later
difference_shifted_and_non_shifted_CO2 <- streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
filter(modelled_or_observed != "observed") |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
plot_difference_residuals <- difference_shifted_and_non_shifted_CO2 |>
ggplot(aes(x = year, y = shifted_CO2_minus_non_shifted_CO2)) +
geom_line(na.rm = TRUE) +
theme_bw() +
labs(
x = "Year",
y = "Observed streamflow minus CO2 model streamflow (mm)",
colour = "Residual Type",
title = "Observed minus modelled streamflow residuals"
) +
facet_wrap(~gauge, scales = "free_y", nrow = 5)
plot_difference_observed_residuals
plot_difference_residuals
View(shifted_streamflow)
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_streamflow, .keep = TRUE)
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep = TRUE) # remove duplicate observed_streamflow
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep_all = TRUE) # remove duplicate observed_streamflow
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep_all = TRUE) |>  # remove duplicate observed_streamflow
arrange(year)
View(all_streamflow)
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow) |>
distinct(observed_boxcox_streamflow, .keep_all = TRUE) |>  # remove duplicate observed_streamflow
arrange(gauge)
View(all_streamflow)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) #|>
# Combine for plotting
all_streamflow <- rbind(only_CO2_non_shifted_streamflow, shifted_streamflow)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) #|>
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) #|>
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct()
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(!c(is_CO2_shifted, streamflow_model, objective_function))
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(is_CO2_shifted, streamflow_model, objective_function)
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
!distinct(is_CO2_shifted, streamflow_model, objective_function)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(pick(is_CO2_shifted, streamflow_model, objective_function))
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(!pick(is_CO2_shifted, streamflow_model, objective_function))
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
distinct(pick(!is_CO2_shifted, !streamflow_model, !objective_function))
View(streamflow_results)
# Convert boxcox streamflow to real space
# remove duplicate observed_streamflow
streamflow_results <- all_streamflow |>
left_join(
gauge_information,
by = join_by(gauge)
) |>
pivot_longer(
cols = ends_with("streamflow"),
names_to = "modelled_or_observed",
values_to = "boxcox_streamflow"
) |>
mutate(
streamflow = boxcox_inverse_transform(boxcox_streamflow, lambda = bc_lambda),
modelled_or_observed = case_when(
modelled_or_observed == "observed_boxcox_streamflow" ~ "observed",
(modelled_or_observed == "modelled_boxcox_streamflow") & (!is_CO2_shifted) ~ "no_shifted_CO2",
(modelled_or_observed == "modelled_boxcox_streamflow") & (is_CO2_shifted) ~ "shifted_CO2",
)
)
View(streamflow_results)
View(streamflow_results)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
filter(gauge == "113004A") |>
filter(modelled_or_observed == "observed")
View(x)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
filter(gauge == "113004A") |>
filter(modelled_or_observed == "observed") |>
arrange(year)
View(x)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
filter(gauge == "113004A") |>
filter(modelled_or_observed == "observed") |>
arrange(year) |>
distinct(year, .keep_all = TRUE)
View(x)
# How to remove the duplicate observed streamflow?
x <- streamflow_results |>
#filter(gauge == "113004A") |>
group_by(gauge) |>
filter(modelled_or_observed == "observed") |>
arrange(year) |>
distinct(year, .keep_all = TRUE)
View(x)
removed_observed_streamflow_results <- streamflow_results |>
filter(modelled_or_observed != "observed")
View(removed_observed_streamflow_results)
cleaned_streamflow_results <- streamflow_results |>
filter(modelled_or_observed != "observed") |>
rbind(cleaned_observed_flow)
# How to remove the duplicate observed streamflow?
cleaned_observed_flow <- streamflow_results |>
group_by(gauge) |>
filter(modelled_or_observed == "observed") |>
arrange(year) |>
distinct(year, .keep_all = TRUE) |>
ungroup()
cleaned_streamflow_results <- streamflow_results |>
filter(modelled_or_observed != "observed") |>
rbind(cleaned_observed_flow)
## Plot 1
plot_streamflow_timeseries <- cleaned_streamflow_results |>
ggplot(aes(x = year, y = streamflow, colour = modelled_or_observed)) +
geom_line(na.rm = TRUE, alpha = 0.9) +
theme_bw() +
scale_colour_brewer(palette = "Dark2") +
labs(
x = "Year",
y = "Streamflow (mm)",
title = "Streamflow timeseries"
) +
facet_wrap(~gauge, scales = "free_y", nrow = 5) +
theme(legend.title = element_blank())
ggsave(
filename = paste0("shifted_CO2_streamflow_timeseries_comparison_", get_date(), ".pdf"),
plot = plot_streamflow_timeseries,
device = "pdf",
path = "./Graphs/examination_selected_sites",
width = 297,
height = 210,
units = "mm"
)
## Plot 2 the shifted - non-shifted timeseries
difference_shifted_and_non_shifted_CO2 <- cleaned_streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2
)
View(difference_shifted_and_non_shifted_CO2)
plot_difference_residuals <- difference_shifted_and_non_shifted_CO2 |>
ggplot(aes(x = year, y = shifted_CO2_minus_non_shifted_CO2)) +
geom_line(na.rm = TRUE) +
theme_bw() +
labs(
x = "Year",
y = "Observed streamflow minus CO2 model streamflow (mm)",
colour = "Residual Type",
title = "Observed minus modelled streamflow residuals"
) +
facet_wrap(~gauge, scales = "free_y", nrow = 5)
ggsave(
filename = paste0("shifted_CO2_vs_non_shifted_residuals", get_date(), ".pdf"),
plot = plot_difference_residuals,
device = "pdf",
path = "./Graphs/examination_selected_sites",
width = 297,
height = 210,
units = "mm"
)
View(difference_to_observed_streamflow)
View(difference_shifted_and_non_shifted_CO2)
## Plot 2 the shifted - non-shifted timeseries
difference_shifted_and_non_shifted_CO2 <- cleaned_streamflow_results |>
select(year, gauge, modelled_or_observed, streamflow) |>
pivot_wider(
names_from = modelled_or_observed,
values_from = streamflow,
) |>
mutate(
shifted_CO2_minus_non_shifted_CO2 = shifted_CO2 - no_shifted_CO2,
observed_minus_shifted = observed - shifted_CO2
)
list_of_observed_minus_CO2_per_catchment <- difference_shifted_and_non_shifted_CO2 |>
select(year, gauge, observed_minus_shifted) |>
pivot_wider(
names_from = gauge,
values_from = observed_minus_shifted
) |>
select(!year) |>
unclass()
remove_na_vector <- function(vector) {
vector[!is.na(vector)]
}
no_NA_list_of_observed_minus_CO2_per_catchment <- map(
.x = list_of_observed_minus_CO2_per_catchment,
.f = remove_na_vector
)
acf_objects_per_gauge <- map(
.x = no_NA_list_of_observed_minus_CO2_per_catchment,
.f = acf,
plot = FALSE
)
get_lags_from_acf <- function(acf_object, name = NULL) {
acf_tibble <- with(acf_object, tibble(lag, acf))
acf_tibble |>
add_column(
gauge = {{ name }},
.before = 1
)
}
lags_from_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = get_lags_from_acf
) |>
list_rbind()
confidence_intervals_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = tibble_confidence_interval_acf
) |>
list_rbind() |>
rename(
gauge = name
)
confidence_interval_acf <- function(acf_object, alpha = 0.05) {
return(qnorm((1 + (1 - alpha)) / 2) / sqrt(acf_object$n.used))
}
tibble_confidence_interval_acf <- function(acf_object, name = NULL, alpha = 0.05) {
upper_bound <- confidence_interval_acf(acf_object, alpha)
lower_bound <- -upper_bound
result_tibble <- as_tibble(cbind(name, upper_bound, lower_bound))
result_tibble$upper_bound <- as.numeric(upper_bound)
result_tibble$lower_bound <- as.numeric(lower_bound)
return(result_tibble)
}
list_of_observed_minus_CO2_per_catchment <- difference_shifted_and_non_shifted_CO2 |>
select(year, gauge, observed_minus_shifted) |>
pivot_wider(
names_from = gauge,
values_from = observed_minus_shifted
) |>
select(!year) |>
unclass()
remove_na_vector <- function(vector) {
vector[!is.na(vector)]
}
no_NA_list_of_observed_minus_CO2_per_catchment <- map(
.x = list_of_observed_minus_CO2_per_catchment,
.f = remove_na_vector
)
acf_objects_per_gauge <- map(
.x = no_NA_list_of_observed_minus_CO2_per_catchment,
.f = acf,
plot = FALSE
)
get_lags_from_acf <- function(acf_object, name = NULL) {
acf_tibble <- with(acf_object, tibble(lag, acf))
acf_tibble |>
add_column(
gauge = {{ name }},
.before = 1
)
}
lags_from_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = get_lags_from_acf
) |>
list_rbind()
confidence_intervals_acf <- map2(
.x = acf_objects_per_gauge,
.y = names(acf_objects_per_gauge),
.f = tibble_confidence_interval_acf
) |>
list_rbind() |>
rename(
gauge = name
)
complete_acf_per_gauge <- lags_from_acf |>
left_join(
confidence_intervals_acf,
by = join_by(gauge)
)
acf_ggplot <- complete_acf_per_gauge |>
ggplot(aes(x = lag, y = acf)) +
geom_hline(aes(yintercept = 0), linewidth = 1) +
geom_segment(mapping = aes(xend = lag, yend = 0), linewidth = 1) +
geom_hline(
aes(yintercept = lower_bound),
linetype = 2,
linewidth = 1,
colour = "blue"
) +
geom_hline(
aes(yintercept = upper_bound),
linetype = 2,
linewidth = 1,
colour = "blue"
) +
labs(
x = "Lag",
y = "ACF",
title = "ACF graphs"
) +
theme_bw() +
facet_wrap(~gauge)
acf_ggplot
source("~/Documents/R-code/climate-change-statistical-streamflow-modelling/testing_new_CO2_model.R")
acf_ggplot
